//ADeanKelly Advertising Code Insertion Script
//Version 0.4
//Read Article for Total Character Count and Paragraph Count
const MAINARTICLE = document.getElementsByTagName('article')[0]; //Find the article element tag
const MAINSIDEBAR = document.getElementsByTagName('aside')[0]; //Find the aside element tag
const TOTALHEADERS = MAINARTICLE.getElementsByTagName('h3').length; //Get total subheads of the article
const TOTALSECTIONS = MAINSIDEBAR.getElementsByClassName('sidebar-advertising').length; //Get total sections in the sidebar

const INARTICLEMAP = ["[760, 0], [[728, 90], [728, 66], [468, 60]], [480, 0]", "[[468, 60], 'fluid']", "[0, 0], [[320, 50], [320, 100]", "[300, 250], 'fluid']"];

const BOUNDRY = 100;

let LoadedInArticleUnits = 0; //Set the starting number of loaded in article ad units
let LoadedSidebarUnits = 0; //Set the starting nu,ber of loaded sidebar ad units

let SlotNum = 1; //Set the slot number for the ad unit starting at 1
let SlotName = ''; //Set the slot name variable
let PositionName = ["top","mid","bottom"];


let ChannelList = [];
let setChannelList = "";

for ( let c = 0; c < CategoryList.length; c++) {
    if ( Object.keys( AdsenseChannels ).includes( CategoryList[c] ) ) {
        let TheCat = CategoryList[c];
        ChannelList.push( AdsenseChannels[TheCat] );
        console.log( 'ChannelList = ' + ChannelList );
    }
}

for ( let a = 0; a < ChannelList.length; a++ ) {
    if ( a == ChannelList.length - 1 ) {
		setChannelList += ChannelList[a]; }
    else {
        setChannelList += ChannelList[a] + "+";
    }
    console.log(setChannelList);
}

for ( let j = 0; j < TOTALHEADERS; j++) {
    SlotName = slot(); //Call to naming the slot function
    
    let AdUnit = document.createElement( 'div' ); //Create the Ad Unit
    AdUnit.setAttribute( 'class', 'leaderboard-adunit' ); //Set in-article ad unit type
    AdUnit.setAttribute( 'id', SlotName ); //Set unique ad unit id
    AdUnit.setAttribute( 'style', 'text-align:center' ); //Set ad unit styles
    
    let TheHeader = MAINARTICLE.getElementsByTagName( 'h3' )[j]; //Find ad unit insertion spot
    MAINARTICLE.insertBefore( AdUnit, TheHeader ); //Insert the ad unit
}

for ( let i = 0; i < TOTALSECTIONS; i++) {    
    let AdUnit = document.createElement( 'div' );
    AdUnit.setAttribute( 'class', 'sidebar-adunit' );
    AdUnit.setAttribute( 'id', PositionName[i] );
    AdUnit.setAttribute( 'style', 'text-align:center;' );
            
    let TheSidebar = MAINSIDEBAR.getElementsByClassName('sidebar-advertising');
    MAINSIDEBAR.insertBefore(AdUnit, TheSidebar[i]);
}
function CheckViewability( GLOBALADUNIT, ADUNITLIMIT, ADUNITCLASS, TARGETING ) {
	for ( let i = 0; i < ADUNITLIMIT; i++ ) {
        
		let AdUnit = document.getElementsByClassName( ADUNITCLASS )[i];
		let AdUnitBoundry = AdUnit.getBoundingClientRect();
        
		if ( AdUnitBoundry.top > -BOUNDRY && AdUnitBoundry.bottom < window.innerHeight + BOUNDRY && !AdUnit.classList.contains( 'loaded' ) ) {
			googletag.cmd.push(function() {
				
				let SIZEMAP = googletag.sizeMapping()
				    .addSize( [1153, 0], [[300, 250]] )
				    .addSize( [760, 0], [[468, 60],[728, 90]] )
				    .addSize( [480, 0],[[320, 50], [468, 60], [320, 100]] )
				    .addSize( [0, 0], [[320, 50], [320, 100], [300, 250], [336, 280], 'fluid'] )
				    .build();
				
				let Sizemap = googletag.sizeMapping().addSize([1153, 0], [[300, 250]])
                    .addSize([760, 0], [[468, 60],[728, 90]]).addSize([480, 0],[[320, 50], [468, 60], [320, 100]]).addSize([0, 0], [[320, 50], [320, 100], [300, 250], [336, 280], 'fluid']).build();
	
				let AMADUNIT = googletag.defineSlot( GLOBALADUNIT, ['fluid', [320, 50], [468, 60],[728, 66], [728, 90], [320, 100], [300, 250]], AdUnit.id )
					.defineSizeMapping( SIZEMAP )
					.setTargeting( TARGETING, i + 1 )
					.set( 'adsense_channel_ids', setChannelList )
					.addService( googletag.pubads() );

                
                googletag.display( AdUnit.id ); // Display has to be called before
                googletag.pubads().refresh([ AMADUNIT ]); // refresh and after the slot div is in the page.

              });
            LoadedInArticleUnits++;
            AdUnit.classList.add('loaded');
            break; //Why?
		}
	}
}

function CheckInArticleViewability() {
    for (let k = 0; k < TOTALHEADERS; k++) {
        var AdUnit = MAINARTICLE.getElementsByClassName('leaderboard-adunit')[k];
        var AdUnitID = AdUnit.id;
        var AdUnitBounds = AdUnit.getBoundingClientRect();
        if (AdUnitBounds.top > - BOUNDRY && AdUnitBounds.bottom < window.innerHeight + BOUNDRY && !AdUnit.classList.contains('loaded')) {
            googletag.cmd.push(function() {


                var AMSlot = googletag.defineSlot( GlobalInArticle, ['fluid', [320, 50], [468, 60],[728, 66], [728, 90], [320, 100], [300, 250]], AdUnitID )
					.defineSizeMapping( INARTICLEMAP )
					.setTargeting( 'slot', k + 1 )
					.set( 'adsense_channel_ids', setChannelList )
					.addService( googletag.pubads() );

                // Display has to be called before
                // refresh and after the slot div is in the page.
                googletag.display( AdUnitID );
                googletag.pubads().refresh([AMSlot]);
              });
            LoadedInArticleUnits++;
            AdUnit.classList.add('loaded');
            break;
        }
    }   
}

function CheckSideViewability() {
    for (var k=0; k<TOTALSECTIONS; k++) {
        var SideAdUnit = MAINSIDEBAR.getElementsByClassName('sidebar-adunit')[k];
        var SideAdUnitID = PositionName[k];
        var SideAdUnitBounds = SideAdUnit.getBoundingClientRect();
        
        if (SideAdUnitBounds.top > -100 && SideAdUnitBounds.bottom < window.innerHeight + 100 && !SideAdUnit.classList.contains('loaded')) {
            googletag.cmd.push(function() {

                //console.log(SideAdUnitID);
                var AMPosition = googletag.defineSlot( GlobalSidebar, [[320, 50], [468, 60], [728, 90], [320, 100], [300, 250], [336, 280]], SideAdUnitID).defineSizeMapping(SIDEBARMAP).set('adsense_channel_ids', setChannelList).setTargeting('position', PositionName[k] ).addService(googletag.pubads());
                
                googletag.display(SideAdUnitID);
					googletag.pubads().refresh([AMPosition]);
				  });
				LoadedSidebarUnits++; //Increment total ad load number
                SideAdUnit.classList.add('loaded');
			}
		}
    }

var CheckView = setInterval( function()
{
	CheckViewability( GlobalInArticle, TOTALHEADERS, 'leaderboard-adunit', 'slot' );
	CheckViewability( GlobalSidebar, TOTALSECTIONS, 'sidebar-adunit', 'position' );
    //CheckInArticleViewability();
	//CheckSideViewability();
    if( LoadedInArticleUnits == TOTALHEADERS && LoadedSidebarUnits == TOTALSECTIONS ) {clearInterval(CheckView); }
}, 50); //Set interval for 0.05s

//Creates and update the slot name for the Google Ad Manager ad unit
function slot() {
  SlotName = 'In-Article-' + SlotNum;
  SlotNum++;
  return SlotName;
}